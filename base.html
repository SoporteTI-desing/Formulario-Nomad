<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Base de registros - Nomad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 24px 12px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid #d0d7e2;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      background: linear-gradient(135deg,#00a8e8,#0052a5);
      color: #fff;
      margin-bottom: 4px;
    }
    .title { font-size: 20px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7280; }
    .logo { height: 50px; }
    .nav-link a { font-size: 12px; color: #0052a5; text-decoration: none; }
    .nav-link a:hover { text-decoration: underline; }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1100px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      white-space: nowrap;
      text-align: left;
    }
    .monto-formulario {
      background: #e0f2fe;
      color: #1d4ed8;
      font-weight: 600;
      border-radius: 6px;
    }

    thead { background: #e5f0ff; }
    tr:nth-child(even) td { background: #f9fafb; }
    .editable { background: #ecfdf3; }
    .editable input,
    .editable select,
    .editable textarea {
      width: 100%;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #9ca3af;
      padding: 3px 5px;
      box-sizing: border-box;
      background: #ffffff;
    }
    .editable textarea {
      min-height: 40px;
      resize: vertical;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .btn-small {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .btn-small:hover { background: #e5edff; }
  
    /* Acceso a base de registros */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      padding: 32px 28px;
      max-width: 360px;
      width: 100%;
      text-align: left;
    }
    .login-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 4px 0;
    }
    .login-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 20px;
    }
    .login-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }
    .login-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    .login-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }
    .login-button {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      margin-top: 4px;
    }
    .login-button:hover {
      filter: brightness(1.05);
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
    }

  </style>
</head>
<body>
  <div id="loginWrapper" class="login-wrapper">
    <div class="login-card">
      <h1 class="login-title">Acceso restringido</h1>
      <p class="login-subtitle">Base de registros de Nomad. Ingresa tus credenciales para continuar.</p>
      <label class="login-label" for="loginUser">Usuario</label>
      <input id="loginUser" class="login-input" type="text" autocomplete="username" />
      <label class="login-label" for="loginPass">Contraseña</label>
      <input id="loginPass" class="login-input" type="password" autocomplete="current-password" />
      <button class="login-button" type="button" onclick="nomadLogin()">
        Entrar
      </button>
      <div id="loginError" class="login-error" style="display:none;">
        Usuario o contraseña incorrectos.
      </div>
    </div>
  </div>

  <div id="protectedContent" style="display:none;">
    <div class="container">
    <header class="header">
      <div>
        <div class="badge">Nomad · Panel de registros</div>
        <div class="title">Base de registros</div>
        <div class="subtitle">Información generada desde el formulario.</div>
        <div class="nav-link">← <a href="index.html">Regresar al formulario</a></div>
      </div>
      <img src="logo-nomad.png" alt="Nomad" class="logo" />
    </header>

    <div class="toolbar">
      <div id="registrosCount">0 registros</div>
      <button class="btn-small" type="button" onclick="exportarExcel()">Descargar Excel</button>
      <button class="btn-small" type="button" onclick="exportarFormularioCompleto()">Descargar formulario completo</button>
    </div>

    <div class="table-wrapper">
      <table id="tablaRegistros">
        <thead>
          <tr>
            <th>Fecha de carga</th>
            <th>KAM</th>
            <th>Hospital</th>
            <th>Estado</th>
            <th>Nombre del paciente</th>
            <th>Prueba</th>
            <th>Biomarcadores Tempus</th>
            <th>Nombre aseguradora</th>
            <th>Tipo de pago</th>
            <th>Aplica Honorario Médico (Monto)</th>
            <th>Monto de prueba</th>
            <th>Nombre del médico</th>
            <th class="editable">Monto de prueba editable</th>
            <th class="editable">Status</th>
            <th class="editable">Fecha de envío</th>
            <th class="editable">Fecha de completado</th>
            <th class="editable">Observaciones</th>
            <th class="editable">Opción logística</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzJZHEkbOkW8D_xeqHTO-y9bcCDW5ZQw",
    authDomain: "formulario-nomad.firebaseapp.com",
    projectId: "formulario-nomad",
    storageBucket: "formulario-nomad.firebasestorage.app",
    messagingSenderId: "36365021080",
    appId: "1:36365021080:web:af4e9158d54b8bedf685ed"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
</script>

<script>
    const STATUS_OPTIONS = [
      "ENVIO",
      "VALIDACION",
      "ES ESPERA DE PAGO y/o CARTA",
      "PAGADA / PENDIENTE",
      "COMPLETADO",
      "CANCELADA"
    ];


    const LOGISTICA_OPTIONS = [
      "AMA_P",
      "MOR_XE",
      "ROS_PE",
      "VER_SB",
      "Azul"
    ];

let registros = [];

function inicializarRegistrosDesdeFirebase() {
  try {
    if (typeof firebase === "undefined" || typeof db === "undefined") {
      console.warn("Firebase no está disponible en base.html, usando solo localStorage.");
      try {
        registros = JSON.parse(localStorage.getItem("nomad_registros") || "[]");
      } catch (e) {
        registros = [];
      }
      cargarRegistros();
      return;
    }

    db.collection("ingresosNomad")
      .orderBy("createdAt", "desc")
      .limit(500)
      .onSnapshot(function(snapshot) {
        try {
          registros = snapshot.docs.map(function(doc) {
            const data = doc.data() || {};
            const resumen = Object.assign({}, data.registroResumen || {});
            resumen.firebaseId = doc.id;
            return resumen;
          });
          localStorage.setItem("nomad_registros", JSON.stringify(registros));
          cargarRegistros();
        } catch (e) {
          console.error("Error procesando snapshot de Firebase en base.html:", e);
        }
      }, function(err) {
        console.error("Error al suscribirse a Firebase en base.html:", err);
        try {
          registros = JSON.parse(localStorage.getItem("nomad_registros") || "[]");
        } catch (e) {
          registros = [];
        }
        cargarRegistros();
      });
  } catch (e) {
    console.error("Excepción al inicializar registros desde Firebase en base.html:", e);
    try {
      registros = JSON.parse(localStorage.getItem("nomad_registros") || "[]");
    } catch (e2) {
      registros = [];
    }
    cargarRegistros();
  }
}


function sincronizarFirebaseDesdePanel(registro) {
  try {
    if (typeof firebase === "undefined") {
      console.warn("Firebase no está disponible en este panel.");
      return;
    }
    if (!registro || !registro.firebaseId) {
      console.warn("Registro sin firebaseId, no se sincroniza con Firestore.");
      return;
    }
    const resumen = Object.assign({}, registro);
    delete resumen.firebaseId;
    db.collection("ingresosNomad").doc(registro.firebaseId)
      .set({ registroResumen: resumen }, { merge: true })
      .then(function() {
        console.log("Registro actualizado en Firebase desde panel:", registro.firebaseId);
      })
      .catch(function(err) {
        console.error("Error al actualizar Firebase desde panel:", err);
      });
  } catch (e) {
    console.error("Excepción al sincronizar con Firebase desde panel:", e);
  }
}



    
    function formatearPesos(valor) {
      if (valor == null) return "";
      if (typeof valor !== "string") valor = String(valor);
      const limpio = valor.replace(/[^0-9,\.\-]/g, "").replace(",", ".");
      const numero = parseFloat(limpio);
      if (isNaN(numero)) return valor || "";
      return "$ " + numero.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

function cargarRegistros() {
      const tbody = document.querySelector("#tablaRegistros tbody");
      tbody.innerHTML = "";

      registros.forEach((reg, index) => {
        const tr = document.createElement("tr");

        const tdTexto = (v) => {
          const td = document.createElement("td");
          td.textContent = v || "";
          return td;
        };

        const tdMontoFormulario = (key) => {
          const td = document.createElement("td");
          td.classList.add("monto-formulario");
          td.textContent = reg[key] || "";
          return td;
        };

        const tdEditInput = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const input = document.createElement("input");
          input.type = "text";
          let value = reg[key] || "";
          if (key === "PAGO AL KAM" || key === "Monto de prueba" || key === "Monto de prueba editable") {
            if (value) value = formatearPesos(value);
          }
          input.value = value;
          input.addEventListener("blur", () => {
            let v = input.value;
            if (key === "PAGO AL KAM" || key === "Monto de prueba" || key === "Monto de prueba editable") {
              v = formatearPesos(v);
              input.value = v;
            }
            registros[index][key] = v;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(input);
          return td;
        };

        const tdEditDate = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const input = document.createElement("input");
          input.type = "date";
          if (reg[key]) input.value = reg[key].substring(0, 10);
          input.addEventListener("change", () => {
            registros[index][key] = input.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(input);
          return td;
        };

        const tdEditArea = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const ta = document.createElement("textarea");
          ta.value = reg[key] || "";
          ta.addEventListener("change", () => {
            registros[index][key] = ta.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(ta);
          return td;
        };

        const tdEditLogistica = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const sel = document.createElement("select");
          const empty = document.createElement("option");
          empty.value = "";
          empty.textContent = "Sin selección";
          sel.appendChild(empty);
          LOGISTICA_OPTIONS.forEach((c) => {
            const o = document.createElement("option");
            o.value = c;
            o.textContent = c;
            sel.appendChild(o);
          });
          sel.value = reg[key] || "";
          sel.addEventListener("change", () => {
            registros[index][key] = sel.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(sel);
          return td;
        };


        const tdEditStatus = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const sel = document.createElement("select");
          const empty = document.createElement("option");
          empty.value = "";
          empty.textContent = "Sin status";
          sel.appendChild(empty);
          STATUS_OPTIONS.forEach((s) => {
            const o = document.createElement("option");
            o.value = s;
            o.textContent = s;
            sel.appendChild(o);
          });
          sel.value = reg[key] || "";
          sel.addEventListener("change", () => {
            registros[index][key] = sel.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(sel);
          return td;
        };

        tr.appendChild(tdTexto(reg["FECHA DE CARGA"] ? reg["FECHA DE CARGA"].substring(0, 10) : ""));
        tr.appendChild(tdTexto(reg["KAM"]));
        tr.appendChild(tdTexto(reg["HOSPITAL"]));
        tr.appendChild(tdTexto(reg["ESTADO"]));
        tr.appendChild(tdTexto(reg["NOMBRE DEL PACIENTE"]));
        tr.appendChild(tdTexto(reg["PRUEBA"]));
        tr.appendChild(tdTexto(reg["Biomarcadores Tempus"] || ""));
        tr.appendChild(tdTexto(reg["Nombre Aseguradora"] || ""));
        tr.appendChild(tdTexto(reg["TIPO DE PAGO"] || ""));
        tr.appendChild(tdMontoFormulario("Aplica Honorario Médico (Monto)"));
        tr.appendChild(tdMontoFormulario("Monto de prueba"));
        tr.appendChild(tdTexto(reg["NOMBRE DEL MEDICO"]));
        tr.appendChild(tdEditInput("Monto de prueba editable"));
        tr.appendChild(tdEditStatus("STATUS"));
        tr.appendChild(tdEditDate("FECHA DE ENVIO"));
        tr.appendChild(tdEditDate("FECHA DE COMPLETADO"));
        tr.appendChild(tdEditArea("OBSERVACIONES"));
        tr.appendChild(tdEditLogistica("OPCION LOGISTICA"));

        tbody.appendChild(tr);
      });

      document.getElementById("registrosCount").textContent = registros.length + " registros";
    }

    
    function exportarExcel() {
      const datos = (Array.isArray(registros) && registros.length)
        ? registros
        : JSON.parse(localStorage.getItem("nomad_registros") || "[]");
      if (!datos.length) {
        alert("No hay registros para exportar.");
        return;
      }
      const headers = [
        "FECHA DE CARGA",
        "KAM",
        "HOSPITAL",
        "ESTADO",
        "NOMBRE DEL PACIENTE",
        "PRUEBA",
        "Biomarcadores Tempus",
        "Nombre Aseguradora",
        "TIPO DE PAGO",
        "Aplica Honorario Médico (Monto)",
        "Monto de prueba",
        "NOMBRE DEL MEDICO",
        "Monto de prueba editable",
        "STATUS",
        "FECHA DE ENVIO",
        "FECHA DE COMPLETADO",
        "OBSERVACIONES",
        "OPCION LOGISTICA"
      ];
      const rows = [headers.join("	")];
      datos.forEach((reg) => {
        const row = [
          reg["FECHA DE CARGA"] || "",
          reg["KAM"] || "",
          reg["HOSPITAL"] || "",
          reg["ESTADO"] || "",
          reg["NOMBRE DEL PACIENTE"] || "",
          reg["PRUEBA"] || "",
          reg["Biomarcadores Tempus"] || "",
          reg["Nombre Aseguradora"] || "",
          reg["TIPO DE PAGO"] || "",
          reg["Aplica Honorario Médico (Monto)"] || "",
          reg["Monto de prueba"] || "",
          reg["NOMBRE DEL MEDICO"] || "",
          reg["Monto de prueba editable"] || "",
          reg["STATUS"] || "",
          reg["FECHA DE ENVIO"] || "",
          reg["FECHA DE COMPLETADO"] || "",
          (reg["OBSERVACIONES"] || "").replace(/\r?\n/g, " "),
          reg["OPCION LOGISTICA"] || ""
        ];
        rows.push(row.join("	"));
      });
      const contenido = rows.join("\n");
const blob = new Blob([contenido], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nomad_registros.xls";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }



    function exportarFormularioCompleto() {
      if (typeof firebase === "undefined" || typeof db === "undefined") {
        alert("Firebase no está disponible para exportar.");
        return;
      }
      db.collection("ingresosNomad")
        .orderBy("createdAt", "desc")
        .limit(1000)
        .get()
        .then(function(snapshot) {
          const docs = snapshot.docs.map(function(doc) {
            const data = doc.data() || {};
            const flat = {};
            Object.keys(data).forEach(function(key) {
              const value = data[key];
              if (key === "registroResumen" && value && typeof value === "object" && !Array.isArray(value)) {
                Object.keys(value).forEach(function(subKey) {
                  flat[subKey] = value[subKey];
                });
              } else if (value && typeof value.toDate === "function") {
                // Timestamps de Firestore
                flat[key] = value.toDate().toISOString();
              } else if (Array.isArray(value)) {
                flat[key] = value.join(", ");
              } else {
                flat[key] = value;
              }
            });
            // Siempre agregamos el id de Firebase
            flat.firebaseId = doc.id;
            return flat;
          });

          if (!docs.length) {
            alert("No hay registros para exportar.");
            return;
          }

          // Construir lista de columnas a partir de todas las llaves
          const columnas = [];
          docs.forEach(function(row) {
            Object.keys(row).forEach(function(key) {
              if (columnas.indexOf(key) === -1) {
                columnas.push(key);
              }
            });
          });

          const filas = [];
          filas.push(columnas.join("\t"));

          docs.forEach(function(row) {
            const valores = columnas.map(function(col) {
              let v = row[col];
              if (v === null || v === undefined) v = "";
              if (typeof v === "number") {
                v = String(v);
              }
              v = String(v).replace(/"/g, '""').replace(/\r?\n/g, " ");
              return '"' + v + '"';
            });
            filas.push(valores.join("\t"));
          });

          const contenido = filas.join("\n");
          const blob = new Blob([contenido], { type: "application/vnd.ms-excel" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "nomad_formulario_completo.xls";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        })
        .catch(function(err) {
          console.error("Error al exportar formulario completo:", err);
          alert("Ocurrió un error al exportar el formulario completo. Revisa la consola para más detalles.");
        });
    }


const NOMAD_AUTH_USER = "nomad";
const NOMAD_AUTH_PASS = "Nomad2025*";

function nomadMostrarContenido() {
  var login = document.getElementById("loginWrapper");
  var content = document.getElementById("protectedContent");
  if (login) login.style.display = "none";
  if (content) content.style.display = "block";
}

function nomadLogin() {
  var user = (document.getElementById("loginUser") || {}).value || "";
  var pass = (document.getElementById("loginPass") || {}).value || "";
  if (user.trim() === NOMAD_AUTH_USER && pass === NOMAD_AUTH_PASS) {
    localStorage.setItem("nomad_base_autenticado", "1");
    nomadMostrarContenido();
  } else {
    var err = document.getElementById("loginError");
    if (err) err.style.display = "block";
  }
}

document.addEventListener("DOMContentLoaded", function () {
  try {
    if (localStorage.getItem("nomad_base_autenticado") === "1") {
      nomadMostrarContenido();
    } else {
      var content = document.getElementById("protectedContent");
      if (content) content.style.display = "none";
    }
  } catch (e) {
    console.warn("No se pudo leer el estado de autenticación:", e);
  }
  if (typeof inicializarRegistrosDesdeFirebase === "function") {
    inicializarRegistrosDesdeFirebase();
  }
});

  </script>
  </div>
</body>
</html>
