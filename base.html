<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Base de registros - Nomad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 24px 12px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid #d0d7e2;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      background: linear-gradient(135deg,#00a8e8,#0052a5);
      color: #fff;
      margin-bottom: 4px;
    }
    .title { font-size: 20px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7280; }
    .logo { height: 50px; }
    .nav-link a { font-size: 12px; color: #0052a5; text-decoration: none; }
    .nav-link a:hover { text-decoration: underline; }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1100px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      white-space: nowrap;
      text-align: left;
    }
    thead { background: #e5f0ff; }
    tr:nth-child(even) td { background: #f9fafb; }
    .editable { background: #ecfdf3; }
    .editable input,
    .editable select,
    .editable textarea {
      width: 100%;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #9ca3af;
      padding: 3px 5px;
      box-sizing: border-box;
      background: #ffffff;
    }
    .editable textarea {
      min-height: 40px;
      resize: vertical;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .btn-small {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .btn-small:hover { background: #e5edff; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <div class="badge">Nomad · Panel de registros</div>
        <div class="title">Base de registros</div>
        <div class="subtitle">Información generada desde el formulario.</div>
        <div class="nav-link">← <a href="index.html">Regresar al formulario</a></div>
      </div>
      <img src="logo-nomad.png" alt="Nomad" class="logo" />
    </header>

    <div class="toolbar">
      <div id="registrosCount">0 registros</div>
      <button class="btn-small" type="button" onclick="exportarExcel()">Descargar Excel</button>
    </div>

    <div class="table-wrapper">
      <table id="tablaRegistros">
        <thead>
          <tr>
            <th>Fecha de carga</th>
            <th>KAM</th>
            <th>Hospital</th>
            <th>Estado</th>
            <th>Nombre del paciente</th>
            <th>Prueba</th>
            <th>Nombre aseguradora</th>
            <th>Tipo de pago</th>
            <th>Nombre del médico</th>
            <th class="editable">Pago al KAM</th>
            <th class="editable">Status</th>
            <th class="editable">Fecha de envío</th>
            <th class="editable">Fecha de completado</th>
            <th class="editable">Observaciones</th>
            <th class="editable">Monto de prueba</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzJZHEkbOkW8D_xeqHTO-y9bcCDW5ZQw",
    authDomain: "formulario-nomad.firebaseapp.com",
    projectId: "formulario-nomad",
    storageBucket: "formulario-nomad.firebasestorage.app",
    messagingSenderId: "36365021080",
    appId: "1:36365021080:web:af4e9158d54b8bedf685ed"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
</script>

<script>
    const STATUS_OPTIONS = [
      "ENVIO",
      "VALIDACION",
      "ES ESPERA DE PAGO y/o CARTA",
      "PAGADA / PENDIENTE",
      "COMPLETADO",
      "CANCELADA"
    ];

function sincronizarFirebaseDesdePanel(registro) {
  try {
    if (typeof firebase === "undefined") {
      console.warn("Firebase no está disponible en este panel.");
      return;
    }
    if (!registro || !registro.firebaseId) {
      console.warn("Registro sin firebaseId, no se sincroniza con Firestore.");
      return;
    }
    const resumen = Object.assign({}, registro);
    delete resumen.firebaseId;
    db.collection("ingresosNomad").doc(registro.firebaseId)
      .set({ registroResumen: resumen }, { merge: true })
      .then(function() {
        console.log("Registro actualizado en Firebase desde panel:", registro.firebaseId);
      })
      .catch(function(err) {
        console.error("Error al actualizar Firebase desde panel:", err);
      });
  } catch (e) {
    console.error("Excepción al sincronizar con Firebase desde panel:", e);
  }
}



    
    function formatearPesos(valor) {
      if (valor == null) return "";
      if (typeof valor !== "string") valor = String(valor);
      const limpio = valor.replace(/[^0-9,\.\-]/g, "").replace(",", ".");
      const numero = parseFloat(limpio);
      if (isNaN(numero)) return valor || "";
      return "$ " + numero.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

function cargarRegistros() {
      const registros = JSON.parse(localStorage.getItem("nomad_registros") || "[]");
      const tbody = document.querySelector("#tablaRegistros tbody");
      tbody.innerHTML = "";

      registros.forEach((reg, index) => {
        const tr = document.createElement("tr");

        const tdTexto = (v) => {
          const td = document.createElement("td");
          td.textContent = v || "";
          return td;
        };

        const tdEditInput = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const input = document.createElement("input");
          input.type = "text";
          let value = reg[key] || "";
          if (key === "PAGO AL KAM" || key === "Monto de prueba") {
            if (value) value = formatearPesos(value);
          }
          input.value = value;
          input.addEventListener("blur", () => {
            let v = input.value;
            if (key === "PAGO AL KAM" || key === "Monto de prueba") {
              v = formatearPesos(v);
              input.value = v;
            }
            registros[index][key] = v;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(input);
          return td;
        };

        const tdEditDate = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const input = document.createElement("input");
          input.type = "date";
          if (reg[key]) input.value = reg[key].substring(0, 10);
          input.addEventListener("change", () => {
            registros[index][key] = input.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(input);
          return td;
        };

        const tdEditArea = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const ta = document.createElement("textarea");
          ta.value = reg[key] || "";
          ta.addEventListener("change", () => {
            registros[index][key] = ta.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(ta);
          return td;
        };

        const tdEditStatus = (key) => {
          const td = document.createElement("td");
          td.classList.add("editable");
          const sel = document.createElement("select");
          const empty = document.createElement("option");
          empty.value = "";
          empty.textContent = "Sin status";
          sel.appendChild(empty);
          STATUS_OPTIONS.forEach((s) => {
            const o = document.createElement("option");
            o.value = s;
            o.textContent = s;
            sel.appendChild(o);
          });
          sel.value = reg[key] || "";
          sel.addEventListener("change", () => {
            registros[index][key] = sel.value;
            localStorage.setItem("nomad_registros", JSON.stringify(registros));
            sincronizarFirebaseDesdePanel(registros[index]);
          });
          td.appendChild(sel);
          return td;
        };

        tr.appendChild(tdTexto(reg["FECHA DE CARGA"] ? reg["FECHA DE CARGA"].substring(0, 10) : ""));
        tr.appendChild(tdTexto(reg["KAM"]));
        tr.appendChild(tdTexto(reg["HOSPITAL"]));
        tr.appendChild(tdTexto(reg["ESTADO"]));
        tr.appendChild(tdTexto(reg["NOMBRE DEL PACIENTE"]));
        tr.appendChild(tdTexto(reg["PRUEBA"]));
        tr.appendChild(tdTexto(reg["Nombre Aseguradora"] || ""));
        tr.appendChild(tdTexto(reg["TIPO DE PAGO"] || ""));
        tr.appendChild(tdTexto(reg["NOMBRE DEL MEDICO"]));
        tr.appendChild(tdEditInput("PAGO AL KAM"));
        tr.appendChild(tdEditStatus("STATUS"));
        tr.appendChild(tdEditDate("FECHA DE ENVIO"));
        tr.appendChild(tdEditDate("FECHA DE COMPLETADO"));
        tr.appendChild(tdEditArea("OBSERVACIONES"));
        tr.appendChild(tdEditInput("Monto de prueba"));

        tbody.appendChild(tr);
      });

      document.getElementById("registrosCount").textContent = registros.length + " registros";
    }

    
    function exportarExcel() {
      const registros = JSON.parse(localStorage.getItem("nomad_registros") || "[]");
      if (!registros.length) {
        alert("No hay registros para exportar.");
        return;
      }
      const headers = [
        "FECHA DE CARGA",
        "KAM",
        "HOSPITAL",
        "ESTADO",
        "NOMBRE DEL PACIENTE",
        "PRUEBA",
        "Nombre Aseguradora",
        "TIPO DE PAGO",
        "NOMBRE DEL MEDICO",
        "PAGO AL KAM",
        "STATUS",
        "FECHA DE ENVIO",
        "FECHA DE COMPLETADO",
        "OBSERVACIONES",
        "Monto de prueba"
      ];
      const rows = [headers.join("	")];
      registros.forEach((reg) => {
        const row = [
          reg["FECHA DE CARGA"] || "",
          reg["KAM"] || "",
          reg["HOSPITAL"] || "",
          reg["ESTADO"] || "",
          reg["NOMBRE DEL PACIENTE"] || "",
          reg["PRUEBA"] || "",
          reg["Nombre Aseguradora"] || "",
          reg["TIPO DE PAGO"] || "",
          reg["NOMBRE DEL MEDICO"] || "",
          reg["PAGO AL KAM"] || "",
          reg["STATUS"] || "",
          reg["FECHA DE ENVIO"] || "",
          reg["FECHA DE COMPLETADO"] || "",
          (reg["OBSERVACIONES"] || "").replace(/\r?\n/g, " "),
          reg["Monto de prueba"] || ""
        ];
        rows.push(row.join("\t"));
      });
      const contenido = rows.join("\n");
      const blob = new Blob([contenido], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nomad_registros.xls";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

document.addEventListener("DOMContentLoaded", cargarRegistros);
  </script>
</body>
</html>